## Public-Key Infrastructure (PKI) Lab

### Task 1

Firstly, we copied the openssl.cnf config file to our working directory

<img src="./images/11/1.png">

Then, we changed the config file, created the necessary auxiliary files and generated the self-signed CA file

<img src="./images/11/2.png">

Next, we ran the commands to look at the decoded content of the files:  `openssl x509 -in ca.crt -text -noout` and `openssl rsa -in ca.key -text -noout`

<img src="./images/11/3.png">
<img src="./images/11/4.png">
<img src="./images/11/5.png">
<img src="./images/11/6.png">
<img src="./images/11/7.png">
<img src="./images/11/8.png">
<img src="./images/11/9.png">
<img src="./images/11/10.png">

- Q: What part of the certificate indicates this is a CAâ€™s certificate?
    - R: In the file ca.crt, the line that says `CA=TRUE`
<img src="./images/11/11.png">

- Q: What part of the certificate indicates this is a self-signed certificate?
    - R: The fact that the Authority (Issuer) Key Identifier is the same as the Subject Key Identifier

<img src="./images/11/12.png">

- Q: In the RSA algorithm, we have a public exponent `e`, a private exponent `d`, a modulus `n`, and two secret numbers `p` and `q`, such that `n = pq`. Please identify the values for these elements in your certificate and key files.
    - R: public exponent `e`: `65537`

    <img src="./images/11/13.png">

    - R: private exponent `d`: `00931df0d70fa098549525e00e6074831a0be0231aaa1d32bc8044368f93273a50f946e1125cc42de4356c337e4efda6ae42997ea752b5900748bba642bc193ff7436cf455be9cae9dd2789d7ff225d0d3a09e7f3aab427bb858452f217d7e6dee578f9335ccab26b59f74efa802611e0b814de843e70f66cad3662197e4ebc57b1006e62f55f62bca290c0ca0818058ab67ec72247e59f4c0bd9d39fc12692e4eeaeb6c7ac16ad2583812183dd5488d71f6f80eefd602676c49bda2bde60b7fc17cb44829c88d5f073faf0c286d30307b04dea5dfd93ecb0acde8182bbc99584b29b540dcdb07c8630a46bee249c71f702a1a08bf89c10a9427833bea07401df4cd691ba92591a1e5fafcf773c4ee7f58753d0bb5eca30e9f7cca28e05cf61edd8b60ef00232274e099e2aa96bb883c0458448e7ac92214335322e1394fa0d05951593f093fa50ea4809d8cb89e8c6bc5cd0ebeab55d12b2a8b88af7c37d8b6fee79c6a2e4e47d29ea17fae37bc1ac02d7308f302adb854e7c0e46197aa0f7a259ca06adb3ab3ef6682b7fcc3999aa0ffb9f16ae88e85905c1215c88c6d8771bf2fa7cca8dca642f50cfbac3173d766df7db9a192b3fae472cde97a562f6f2302e1558c6643e5669d41993f28676f74ed8d228063ccb66c449e5d958cb19ca84fb44289f781a52f8f63518749685df9deef2f379a3e6fd3fb60fcbe102c064441` in hexadecimal. <br>
`600184817576804226252763585127812013808517897332078295141075868875802807217730362462622378001833354549080715598046430051729921957502417459487104712100123043584917986403464269615575518492776428586381743133602744567875092273699048809939835485593357198504802247401096115310020670505777252723640457862121834743519390807477343983445477091170662204475933641841785496513961462710379887269597056522380953669152425512928259994797748024931064111492378285146813456176930889561730308118275652355670327965520363156439977576911614111091675722594445375686377743909745578715581552656869519437597213216738201559935196953757893053712616340228674835077250134439613798058784311657634344660858404943883137105644832216764004115307159201796825838451119337229301830769956249720927253310154290603357644515105697744079573786829921704765124544670811878726306900016059689110376402934188713263395693236263551395017642082854715818235447234943293317044178445782460629904396219798932450256315757916251840861066224206079283116989902440611721472739831403250841554454333333921082985092862864892769744977153954471625071300493582341604125513492204374107064720121162276588672818078166363236220301693818545427196155774922671795137373287387501700290378891689611381589820481` in decimal.

    <img src="./images/11/14.png">

    - R: modulus `n`: `00d3918f5d23f8f1b73a69c5d3a5afe46618ffb3c0b582ea2573a822ce0396a58f441b05a59d1fc3d3e33da3e3299d3585dc50fd1b20fda7f1f027178fd7e41d7bc2d0ca10997038c5ebdbb03c20a8a191243604521e7f889c52c3ef3adfef58b734ae28575cc8a16daa5be5a5e8302d8cd0c0ef8a29f28d08a9c9c91e08b1a92b6b9e9af159b55d5d4cc50c5c90cd12a60e6142f176f8386a2949cfbdeb0ae6e6d16ed7407455f2387542d98db438e8c1fc3c85b20e9e38085d87db1fcca43e2e0b21ef39ffb9c1b1c0a00d6f1f14527b91dc9a50a9816daf4b169dce303fc091f9d877a44cb1881dc3e16707cd004c875296e111569ff7218f328ddc1c5e7e2e5417176670805641d4c4f52a147da64728a1837cc7369b34b012b546635307525476d933b04a2424baccc7d4596d7552d378413d2d58aba99e4100d0e17a842a4ffed9ca2aea4a8687e3595b2e5deb4379263e146823a4c43799d7654c138f108fd0abd98d6263c3e6ee866fe6dc3e316e7572c4074395d9ca3eeb25bc84c98288cc53a767757dc22e83d640df57d907a4d99602e13fbe3d6216cb409de920f92ed77bcb9275ab1c15ce06d9f9ea148a2c151e46f49a84340230d55626a9b45f8ee9977728dfc6f4017fbe1c96c9c19aa582d32d50e4a8595e095630adb3ea716d743d3843f63815545ac9375a835f2fa5c61f941ad69343d13a4e581c2ff49b` in hexadecimal. <br>
`863124558709975831122780810114136222877399224029062038722476284089210229452918343823244158411001328822151822569761451906877554097446588542140050502872504254968506321314048929996400701208221908195069347400748772727657990045234235097363007948286927295672983956989503118341806913958946805313552722876105474492803263305311215058436457301063189873052296653326277014066433169087381872026410565551375418252770177100868502046850259201042463545046870790697505342698751858799418923969705771711436107343902133770376696446459590406359500391285705402140747349306876941812583784263873819349201451825361439384566685744721123432396348989552653662097566015831749768437474244778090348319995831101782565127469685317606631092794423853409732919032057422373805354825419642633530450908641557002744199905597144596809442326418463940336767056281900105980114758283524063567913226277035192639534721791280600446663553247594296303208420785623622675368593656146455042983160153522263985204569439268887047764664797835544408162548503172927826009634835279522349936006559230265300898884575951400757149670036005138895220323391861517628516348158667880061939899354040504074731935562280098617537074394960922803899332876392231677118427062920040773913529921759273063740863643` in decimal.

    <img src="./images/11/15.png">

    - R: secret number `p`:
`00f03808d02fd2cbb8d48729616286f926e6895d8d1700fa1185ec5d6dc60aa4b9d53e0e85f5437ebb2f440571ae11b93eb3333e88bc8c6fd22cc61a29d913cea4df567db105b4dcec1f87149c84b1e0880cfb2633eaa6abb939ebc2957aaee5356eeca0162875400d7ba5e30e04e119219732f9480f6f10bc8433da516ef7689412c82d21e8f726c9d98839195e286531c787df3aff3c58511a05079fe01ef5cc64f9e88832cd3bdd2433bb9f95656ff4b53a494590558f20c5c55088e2ff368b894a66cff26054271f62403ce423c13de88db241214607a5dd86a0a04a9c0057f9d1f4044deb863c5efdfb7b7db11dff493da745551977782cbb79ca0379b303` in hexadecimal. <br>
`30324824797493343815521581310498929516149970994212115242794391926901845036626450026554049683433994050955879609475817148194702652321596894582251973491798671280936497600578969154537051856795844908720486952595260446381378614449782934492158487504175892068163114660920612545340247306155982893991866206122269474850343225096576295706315668641992099134899311649462221894785998251269904266313739392063678471796821346108639824622459819373026633701495108135783796279107122151379431248575030387011042689167411053711768265086679399714675747986901101836673144303009386993591389453600856325977666554449847618417726097280619104547587` in decimal.

    <img src="./images/11/16.png">

    - R: secret number `q`:
`00e177b0729bc16295f60bc3a54d885eaab6f3b81627a7775fb9742b6e6f00d1c1a076a359a89606d8e3fae1a7dd6799f18b106a5cc3dd422b930f6cdd453ce48431d6fb9369645ae07edd20494e703102273a3d5296fd1d04d76b039840e801bcefcc3d7f15422922f2bdf491cc4e59702c8504de0b9637f3bd335723326413e5ff294bd2d3ae86a33435298c7e62f62016b3741434888faf76d1a4845f64ec559047e0f5e3d4bf5ae58e04c74d2ac53766d993e2bbe4a6157280e8a33c4f963de03abd5c68a7124129fb834d61aae5d791d6619401fe4118d39d5069fd9c90efca0a6bee14ef1e097a331b769cb7d142d368d10e45b18020d21614addb77b889` in hexadecimal. <br>
`28462639585681031953292881858353959407506000232666397883088390552820385640173565419484185547457589364952432765621015302044557132928144528546869167143488181541163245912783633146368733100407260591042108605812391919979862018927176156401443478596107128771668225794515966496181727049100765770048478873337013479007887632911123976042992225546947190219806643856630251984065734558608774428787426812985403247863994144590217575036838356354985521502175583469896186937387918286623789087728119785401255225082886592387251544922135901387608309228926748295637094865189558787720311192401964522853303687747098244323083385549428853553289` in decimal.

    <img src="./images/11/17.png">

<img src="./images/11/18.png">

### Task 2

Generating a CSR for www.costa2022.com

<img src="./images/11/19.png">

Adding 2 alternative names to our CSR for www.costa2022.com

<img src="./images/11/20.png">

### Task 3

After turning our CSR into a X509 certificate and uncommenting the extension copying option, we verified that the alternative names were included in the content of the certificate.

<img src="./images/11/21.png">

### Task 4

NOTE: Our group had problems setting up the Apache server for our own website, so we had to redo the whole lab up until now with the ban32.com website instead, as we didn't manage to resolve our issue in a reasonable time.

Firstly, we uncommented the extension copying option line in our version of the openssl.cnf file and then we turned the server.csr certificate signing request into the server.crt X509 certificate using with the given command

<img src="https://cdn.discordapp.com/attachments/1049764414255018045/1057016372615458916/image.png">

Then, we checked for the presence of the alternative names in the certificate, which they were present.

<img src="https://cdn.discordapp.com/attachments/1049764414255018045/1057017028512334005/image.png">

After that, we fired up the docker container and started a shell on it. With shell access, we enabled the SSL module and the sites described in the bank32_apache_ssl file with the commands `a2enmod ssl` and `a2ensite bank32_apache_ssl` and started the apache server with `servive apache2 start`

Theoritically, to run this whole process for our website, we'd have to create a personalized apache_ssl.conf file, alter the Dockerfile and change the build directory of the website in the docker-compose.yml file.

Something we found strange was the fact that when we loaded up the https://bank32.com website, we could access it, despite the lab handout telling us we weren't supposed to. We did get a warning from Firefox though.

<img src="https://cdn.discordapp.com/attachments/1049764414255018045/1057018785082638386/image.png">

We decided to load the ca.crt certificate into Firefox anyway, which, contrary to what we believed, did not remove the warning. We can't really explain why we could access the website without the certificate loaded and why, after having loaded it, the warning's still there. <br>
Anyhow, both the HTTPS and the HTTP versions of the website are up and running.

<img src="https://cdn.discordapp.com/attachments/1049764414255018045/1057015113267290142/image.png">
<img src="https://cdn.discordapp.com/attachments/1049764414255018045/1057015176978771988/image.png">

### Task 5

We changed the VirtualHost entry and emulated the result of a DNS cache poisoning attack.

<img src="https://cdn.discordapp.com/attachments/1049764414255018045/1057030070486695946/image.png">

When we tried to access the website we targeted, Firefox stopped us from accessing it.

<img src="https://cdn.discordapp.com/attachments/1049764414255018045/1057030728593985656/image.png">

Even so we still chose to go through with the loading of the webpage, leading us to our website, instead of the real youtube.com

<img src="https://cdn.discordapp.com/attachments/1049764414255018045/1057031012196036628/image.png">

### Task 6

## Week 11 CTF Challenge
### Challenge 1

In this CTF we're told that the public exponent `e` is 0x10001 and that the primes `p` and `q` are the next primes of 2^512 and 2^513. Then, when we have these numbers, we can calculate the private exponent `d` and use it to decrypt the flag. <br>

With this in mind, we built a script that calculates both primes and with those, calculates the private exponent using the Extented Euclidean Algorithm.

```py
from binascii import hexlify, unhexlify
from sympy import *

p = 2**512
q = 2**513

while True:
    if isprime(p):
        print(p)
        print('\n')
        break
    else:
        p += 1

while True:
    if isprime(q):
        print(q)
        print('\n')
        break
    else:
        q += 1

# Iterative Algorithm (xgcd)
def iterative_egcd(a, b):
    x,y, u,v = 0,1, 1,0
    while a != 0:
        q,r = b//a,b%a; m,n = x-u*q,y-v*q # use x//y for floor "floor division"
        b,a, x,y, u,v = a,r, u,v, m,n
    return b, x, y

def modinv(a, m):
    g, x, y = iterative_egcd(a, m) 
    if g != 1:
        return None
    else:
        return x % m

n = p*q
e = 0x10001 # a constant
k = ((p-1)*(q-1))
d = modinv(e,k) # a number such that d*e % ((p-1)*(q-1)) = 1

enc_flag = "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000671e6f3cb7da4a3bfb641f806fd8e3afff8b281a918333308c316444b627928f4f793acc72a45646f4e2a8062fe4b353d29cf90d2ff52dcc250fd2bf5c28d0c30c7b5f0aea90e22065203f1a3896e0c1131f0c8b53e5913c000ad69f43acf289196adaadaf603ce52d510e905619cd79c8d278f94a94ff3285e1d5fd7bf37bb"

def enc(x):
    int_x = int.from_bytes(x, "big")
    y = pow(int_x,e,n)
    return hexlify(y.to_bytes(256, 'big'))

def dec(y):
    int_y = int.from_bytes(unhexlify(y), "big")
    x = pow(int_y,d,n)
    return x.to_bytes(256, 'big')

y = dec(enc_flag)
print(y.decode())

```

After that, to get the flag (flag{788cfba5f093bd21fc231be23f4c8875}), all we needed to do was get the encrypted flag from the server, plug it into the python script and run it.

<img src="https://cdn.discordapp.com/attachments/1021902913079103488/1055960409082957906/image.png">

### Challenge 2
In this CTF we're told that the public exponent `e1` is 65537, `e2` is 65539 and the `n` is 29802384007335836114060790946940172263849688074203847205679161119246740969024691447256543750864846273960708438254311566283952628484424015493681621963467820718118574987867439608763479491101507201581057223558989005313208698460317488564288291082719699829753178633499407801126495589784600255076069467634364857018709745459288982060955372620312140134052685549203294828798700414465539743217609556452039466944664983781342587551185679334642222972770876019643835909446132146455764152958176465019970075319062952372134839912555603753959250424342115581031979523075376134933803222122260987279941806379954414425556495125737356327411 for both. We converted both messages to decimal, being `m1` 15530047004574221370578380986724232869171275773080445512621274958443895617394976969896055161719093025779304408977290439873775587057312522695640883862655939626067502189414957632820061958259393502208075668991587690748896584426879074042765442612391390590159713947516970974489338075999453907088026205995683285813604137688694685400374165064562939205681328371185069535773799192375610863444067426021584987273673533420513513428591375326666134016590514722895411059980996193079435294633463695170409323958769500258361115286635087578850098310111991322415819643868784614879425813103999022237153661931125502003237737253055982758320 and `m2`  23359690748408523720703329553747499608697611512837651200474993914267732912567421916915751957378055078078236850795771695404168417678366260688574678931042365519838739208245904503603538021174817002067118255818967696932937111938102673746622950795822830097810552925965457012037441530669606793306462823345230810033027828762347790358225680176834876900570671863225801684826865821260074992013446291544944274810691982760234143581943153948726238440884372929500137420832420042603955924805733489054394007685657107735790185793408060502725328677492663170313288240480715390823953076158341165911170869439104133269595172764249962245319

Then, we used this script in order to decrypt the messages.

```py
import argparse
import math
from binascii import unhexlify



def egcd(a, b):
    if a == 0:
        return b, 0, 1
    else:
        g, y, x = egcd(b % a, a)
        return g, x - (b // a) * y, y


def modinv(a, m):
    return pow(a, -1, m)


def attack(c1, c2, e1, e2, N):
    if math.gcd(e1, e2) != 1:
        raise ValueError("Exponents e1 and e2 must be coprime")
    s1 = modinv(e1, e2)
    s2 = (math.gcd(e1, e2) - e1 * s1) // e2
    temp = modinv(c2, N)
    m1 = pow(c1, s1, N)
    m2 = pow(temp, -s2, N)
    return (m1 * m2) % N


def main():
    args = parser.parse_args()
    print('[+] Started attack...')
    try:
        message = attack(args.ct1, args.ct2, args.e1, args.e2, args.modulus)
        print('[+] Attack finished!')
        print('\nPlaintext message:\n%s' % unhexlify(hex(message)[2:])) 
        # format(message, 'x').decode('hex'))
    except Exception as e:
        print('[+] Attack failed!')
        print(e.message)

    main()

```

We ran the script with our values and got the flag{0b22b086d121d7299b7d462f87a8082b}.
<img src="./images/11/31.png">



